# サザンウィズ資機材予約サイト 要件定義

## 1. プロジェクト概要

- **目的**: サザンウィズ資機材の貸出申請プロセスをWeb予約サイト化し、利用者の予約と管理者の把握を効率化する。
- **対象資機材**: 添付申請書に記載された救急・トレーニング機材、機械類、消耗品など。

## 2. ステークホルダーとロール

- **一般ユーザ（医療スタッフ等）**: 認証済みの利用者としてログインし、資機材を検索・予約する。
- **管理者（医療安全管理室／総務課など）**: 資機材リスト・保有数を管理し、予約状況をガントチャートで俯瞰する。
- **システム管理者（IT部門）**: ユーザ管理、権限設定、バックアップ、障害対応を行う。

## 3. 想定利用シナリオ

1. 利用者がログインし、カテゴリーから資機材を選択する。
2. 資機材詳細ページで保有数および既予約状況を確認する。
3. カレンダー表示で使用日・期間を選択し、申請理由や利用場所を入力して予約する。
4. 予約が保有数上限を超える場合は予約不可または警告が表示される。
5. 管理者はダッシュボードで予約一覧やガントチャート表示、承認状況（任意）を確認する。
6. 管理者が資機材の保有数変更やメンテナンスによる貸出不可期間設定を行う。

## 4. 機能要件

### 4.1 認証・認可

- シングルサインオン（院内ADなど）またはID/パスワード方式。
- ロールベースアクセス制御（一般ユーザ／管理者／システム管理者）。

- （本番）シングルサインオン（院内ADなど）またはID/パスワード方式。
- ロールベースアクセス制御（一般ユーザ／管理者／システム管理者）。

#### 開発用仮アカウント（ローカル環境のみ）

- **管理者メールアドレス**: [admin@sazan-with.local](mailto:admin@sazan-with.local)
- **管理者パスワード**: `Sazan-Admin@2025`
- 初期ログイン後は、運用ルールに従い速やかにパスワード変更と多要素認証設定を行う。

### 4.2 資機材管理

- 資機材マスタ登録・更新（名称、カテゴリ、保有数、保管場所、備考）。
- 利用制限設定（メンテナンス期間、特定部署専用フラグなど）。

### 4.3 予約機能（利用者）

- カテゴリ／検索機能、フィルタ（名称、用途、部署）。
- 資機材単位カレンダー（月／週／日表示、予約ステータス別色分け）。
  - 日付セル内に以下のボタンを表示：
    - 「予約可能」ボタン：空きがある場合に表示、クリックで予約フォームを表示
    - 「残り○」ボタン：残り数が少ない場合に表示、残数を明示
    - 「×」ボタン：予約不可の場合に表示、ツールチップで理由を表示
  - 日付セルをホバーした際に、その日の予約状況をツールチップで表示
  - ボタンクリックでモーダルを表示し、予約詳細を入力可能に
- 予約入力（利用開始／終了日時、使用目的、利用場所、担当者連絡先、連続日程、備考）。
- 保有数チェック（同時予約件数が保有数を超える場合は予約不可）。
- 予約履歴・ステータス確認、キャンセル／変更（期限・権限設定あり）。

### 4.4 予約管理（管理者）

- 予約一覧（フィルタ：日付、資機材、部署、ステータス）。
- ガントチャート表示（資機材×タイムライン、拡大縮小、期間フィルタ、部署別色分け）。
- 予約承認ワークフロー（オプション：自動／手動）。
- 予約変更・強制キャンセル、コメント記録。
- 利用実績エクスポート（CSV/Excel）。

### 4.5 通知

- 予約受付／承認／却下／キャンセルメール送信。
- 返却期限リマインダ（前日・当日通知）。
- 管理者への上限超過申請やメンテナンス開始通知。

### 4.6 監査・ログ

- ログイン履歴、予約操作履歴の保存。
- 操作ログの検索・エクスポート機能。

### 4.7 管理画面（システム管理者向け）

- ユーザアカウント・ロール管理。
- システム設定（通知テンプレート、メンテナンスモード）。
- バックアップ・リストア操作（UIまたは手順書整備）。
- 管理者アカウント一覧（登録日時・最終ログイン表示）からの削除操作。
  - 削除前に確認ダイアログを表示し、処理中は対象行の操作ボタンをローディング表示する。
  - 削除は論理削除（`isActive=false` と `deletedAt` 設定）とし、本人アカウントは削除不可。
  - system_admin ロールのみが system_admin アカウントを削除できるよう、ロール間の権限制御を行う。

### 4.8 今後の拡張要件（第1弾）

#### 4.8.1 予約データのCSVエクスポート機能

- 管理画面 `/admin/reservations` から、条件に合致する予約データを CSV としてダウンロードできること。
- 画面要件
  - 予約管理画面上部の見出し右側に「CSVダウンロード」ボタンを配置する。
  - 既存のフィルタ（例: ステータス）と同じ条件を CSV 出力に反映できるようにする。
  - ページングに関係なく、指定条件に合致するレコードを全件出力することを基本とする。
- API 要件（案）
  - エンドポイント: `GET /api/reservations/export`
  - 認可: 管理者ロールのみアクセス可能（既存の認証・認可に準拠）。
  - 主なクエリパラメータ（初期案）
    - `status`: `pending` / `approved` / `rejected` / `cancelled` / `completed` など（任意）。
    - 今後 `startDate` / `endDate` / `equipmentId` を追加できる余地を残す。
  - レスポンス
    - `Content-Type: text/csv; charset=utf-8`
    - `Content-Disposition: attachment; filename="reservations_YYYYMMDD.csv"` の形式でダウンロード可能とする。
  - CSV 出力列（初期案）
    - 予約ID（`id`）
    - ステータス（`status`）
    - 機材名（`equipment_name`）
    - 部署（`department`）
    - 申請者（`applicant_name`）
    - 連絡先（`contact_info`）
    - 利用開始日時（`start_time`）
    - 利用終了日時（`end_time`）
    - 数量（`quantity`）
    - 作成日時（`created_at`）

#### 4.8.2 管理者向けカレンダーの高度化

- 管理者が予約状況を詳細に把握できるカレンダー画面を提供する（一般ユーザ向けカレンダーとは表示項目・操作性を差別化）。
- 表示場所候補
  - `/admin` ダッシュボード内、または `/admin/reservations` 内のタブ／セクションとして配置。
- 表示モード
  - 月ビューに加え、時間軸を重視した週ビューを提供する（FullCalendar 等の既存コンポーネントを拡張）。
- 情報表示
  - 各イベント（予約）に対して、少なくとも以下の情報を確認できること。
    - 機材名
    - 部署
    - 申請者
    - 期間（開始〜終了）
    - ステータス
  - マウスホバー時のツールチップ、またはクリック時の詳細モーダルで上記情報を表示する。
- フィルタ機能
  - 日付範囲（カレンダーの表示期間＋必要に応じて From/To 入力）。
  - 機材またはカテゴリ別フィルタ。
  - ステータス別フィルタ。
- 管理者アクション（将来的な拡張）
  - カレンダー上のイベントクリックから、予約詳細の確認・ステータス変更・キャンセルなどを行えるようにすることを検討する。

#### 4.8.3 データ基盤・API 安定化方針（検討事項）

- **RDB移行**: SQLite 開発環境から、PostgreSQL / MySQL などサーバ型 RDB への切替を前提とする。TypeORM で接続プールを設定し、API の同時アクセス時も安定稼働させる。
- **キャッシュ/集計レイヤ**: 管理者向けの重い集計 API は Redis 等のキャッシュを挟む。日次／週次レポートはバッチで事前計算し、API は結果を返すのみとする。
- **DWH/BI 連携**: 予約履歴を BigQuery / Redshift / Snowflake 等の DWH に定期連携し、社内分析・統計処理に活用できるようにする。ETL（Airflow など）で運用。
- **インフラ運用**: API サーバは Docker 化し、ロードバランサ＋オートスケール＋監視（APM, ログ集約）を導入。バックアップ/スナップショットを自動化して障害耐性を確保する。

## 5. データ要件

### 5.1 主なデータモデル

- **ユーザ**: 氏名、所属、連絡先、役職、認証情報、ロール。
- **資機材**: ID、カテゴリ、名称、保有数、保管場所、利用条件、備考。
- **予約**: 予約ID、ユーザID、資機材ID、利用期間、数量（デフォルト1）、用途、ステータス、承認者、作成日時、更新日時。
- **カレンダーイベント**: 資機材ID、期間、予約/メンテナンス種別。
- **通知履歴**: 種別、送信先、送信日時、結果。
- **ログ**: 操作種別、対象ID、実行者、日時、詳細。

#### 5.1.1 資機材カテゴリ分類

- 資機材は、以下のカテゴリに分類して管理する。
  - **蘇生講習資機材**
  - **トレーニング資機材**
  - **機械類**
  - **消耗品**
  - **その他**
- 画面上のカテゴリ選択肢や一覧表示では、上記の順序（蘇生講習資機材 → トレーニング資機材 → 機械類 → 消耗品 → その他）で表示することを基本とする。
- 各カテゴリ配下には、院内で使用している具体的な物品（例: ALS Simulator, Resusci Anne, AEDトレーナー 等）を資機材マスタとして登録する。
- 物品名が複数の呼称を持つ場合は、1つの資機材レコードに対して別名（エイリアス）として扱う。
  - 例: **「超音波トレーニングシミュレーター」** と **「経食道心エコー基本システム」** は同一物品として1レコードで管理し、画面上ではいずれの名称でも検索・識別できるようにする（カテゴリは「トレーニング資機材」とする）。

### 5.2 データ制約

- 1予約で保有数を超える数量指定を不可とする。
- 重複予約判定は「資機材ID × 時間帯 × 数量条件」で行う。
- 過去データ保存期間（例：5年）を定義しアーカイブ方式を決定する。

## 6. 非機能要件

### 6.1 ユーザビリティ

- PCブラウザ（Edge/Chrome）最適化、レスポンシブ対応（タブレット）。
- カレンダー操作性（ドラッグ＆ドロップ、ツールチップ表示）。
- アクセシビリティ（キーボード操作、色弱対応）。

### 6.2 パフォーマンス

- 同時アクセス数50ユーザでも2秒以内のレスポンスを目標とする。
- 予約登録時の競合処理（悲観／楽観ロックまたはトランザクション管理）。

### 6.3 セキュリティ

- HTTPS通信必須。
- パスワードポリシー／アカウントロック。
- 権限による閲覧制限（他部署予約の詳細閲覧権限制御）。
- ログの改ざん防止と定期バックアップ。

### 6.4 可用性・保守性

- 稼働時間: 平日24時間を想定（メンテナンス時間帯設定）。
- 障害通知と復旧手順の整備。
- バージョン管理・テスト環境での検証フロー。

### 6.5 法令・コンプライアンス

- 個人情報保護（利用者情報は最小限で暗号化保管）。
- 監査要件に沿ったアクセスログ保持。

## 7. インテグレーション要件

- 既存人事システム／LDAPとのユーザ連携（任意）。
- Outlook/Googleカレンダー連携（ICS配信）を検討。
- 既存申請書PDFの出力（電子申請書としてアーカイブ）。

## 8. システム構成要件（案）

- Webアプリ構成（フロント：SPAまたはサーバサイドレンダリング、バックエンド：Firebase を用いた REST API / サーバーレス構成）。
- 認証・認可: Firebase Authentication を利用し、ユーザのログイン・ロール管理と連携。
- データベース：Firebase Firestore などのマネージド NoSQL データベースを基本とし、必要に応じて別途リレーショナルDB（例：PostgreSQL/MySQL）を検討。
- 業務ロジック: Firebase Cloud Functions 等を利用したサーバーレス処理（予約競合チェック、通知処理、バッチ処理など）。
- ガントチャート表示ライブラリ（例：DHTMLX Gantt、FullCalendar＋カスタム）。

## 9. 移行・運用計画

- 既存Excel/紙申請からの初期データ登録手順を整備。
- 利用者向けトレーニング資料、FAQを用意。
- 運用フロー（承認ルール、返却確認、機材メンテ処理）を確立。

---

### 次のステップ（推奨）

1. 関係部署とのレビューで要件確定。
2. 画面プロトタイプ作成とフィードバック収集。
3. システムアーキテクチャ案・スケジュール策定。
