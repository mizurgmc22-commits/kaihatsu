# サザンウィズ資機材予約サイト 要件定義

## 1. プロジェクト概要

- **目的**: 救急・トレーニング機材や消耗品の貸出申請を Web 化し、利用者の予約と管理者のモニタリングを一元化する。
- **対象範囲**: 添付申請書に記載された資機材全般（蘇生講習資機材、トレーニング資機材、機械類、消耗品 など）。
- **開発・検証環境**: フロントエンドは React + Vite、バックエンドは Express + TypeORM（開発時は SQLite、本番は PostgreSQL / MySQL を想定）。`npm run dev` で API と UI を同時起動し、<http://localhost:5173> 経由で UI を確認する。

## 2. ステークホルダーとロール

- **一般ユーザ（医療スタッフ等）**: 認証後に資機材を検索し、予約・キャンセルを行う。
- **管理者（医療安全管理室／総務課）**: 資機材マスタや保有数、予約状況の監視、承認／強制キャンセル、通知設定を担う。
- **システム管理者（IT部門）**: ユーザ・ロール管理、監査ログ、バックアップ／障害対応、環境構築を担当する。

## 3. 想定利用シナリオ

1. 利用者がシングルサインオンまたはID/パスワードでログイン。
2. カテゴリ・検索条件で資機材を絞り込み、詳細情報や保有数・予約状況を確認。
3. カレンダー表示から利用期間を選択し、利用目的・場所・連絡先などを入力して予約申請。
4. システムが保有数・重複をチェックし、上限超過時は警告または予約不可として理由を提示。
5. 管理者はダッシュボードで予約一覧／ガントチャートを確認し、必要に応じて承認、調整、メンテナンス設定を行う。
6. 返却期限前に自動通知が届き、利用完了後は実績やログに記録される。

## 4. 機能要件

### 4.1 認証・認可

- 本番: 院内AD等との SSO または ID/パスワード方式に対応し、ロールベースアクセス（`user` / `admin` / `system_admin`）。
- 開発: バックエンド起動時に `admin@sazan-with.local / Sazan-Admin@2025` の仮管理者を自動生成し、ログイン可否を常に保証する。初期ログイン後はパスワード変更と多要素認証を必須化する。
- JWT によるトークン発行と `/auth/me` エンドポイントでの利用者情報取得。トークン失効時は自動ログアウト。

### 4.2 資機材管理

- 名称、カテゴリ、保有数、保管場所、備考、利用制限（メンテナンス期間、部署限定フラグ等）を持つマスタを登録・更新。
- TypeORM シード／マイグレーションによりマスタをコード管理し、環境間で差異なく再現。
- 非アクティブ資機材の貸出抑止や論理削除（`isActive` / `isDeleted`）をサポート。

### 4.3 予約機能（利用者）

- カテゴリ／フリーワード／部署フィルタで検索可能。
- 資機材ごとのカレンダー（月/週/日ビュー) に予約可否ボタンを表示。
  - 「予約可能」「残り○」「×」などの状態表示と、ホバー時ステータスツールチップ。
  - ボタン押下でモーダルを開き、開始・終了日時、利用目的、利用場所、担当者連絡先、連続日程、備考を入力。
- 申請時に保有数チェックと重複判定を行い、条件未達時は理由付きで差し戻し。
- 予約履歴参照、ステータス確認、キャンセル／変更（期限と権限で制御）。

### 4.4 予約管理（管理者）

- 予約一覧（フィルタ：日付、資機材、部署、ステータス、キーワード）。
- ガントチャートや FullCalendar による視覚化（資機材×タイムライン、ズーム、部署色分け）。
- 任意の承認ワークフロー（自動承認／手動承認）とコメント履歴。
- 管理者による変更・強制キャンセル、備考記入、実績エクスポート（CSV/Excel）。

### 4.5 通知

- 予約受付／承認／却下／キャンセル時にメール通知。
- 返却期限前リマインダ（前日・当日）と上限超過・メンテナンス開始アラート。
- メールテンプレートは管理画面から編集可能。

### 4.6 監査・ログ

- ログイン履歴、予約操作、管理アクションを監査ログとして保存し、検索・エクスポート機能を提供。
- ログ改ざん防止のための署名または外部保管を検討。

### 4.7 管理画面（システム管理者向け）

- ユーザ／ロール管理、通知テンプレート、メンテナンスモードの設定。
- バックアップ・リストア手順（UI or 手順書）の提供。
- 管理者アカウント一覧からの論理削除（`isActive=false`, `deletedAt` 設定）。
  - 削除前に確認ダイアログ、処理中は操作ボタンをローディング表示。
  - system_admin のみが system_admin アカウントを削除可能。

### 4.8 今後の拡張要件（第1弾）

#### 4.8.1 予約データ CSV エクスポート

- `/admin/reservations` から条件一致データを CSV ダウンロード。
- フィルタ条件（ステータス等）を出力にも反映し、ページング無視で全件出力。
- API案: `GET /api/reservations/export`（管理者限定）。`status` 等のクエリを受け取り、`text/csv` で応答。
- 出力列: 予約ID、ステータス、機材名、部署、申請者、連絡先、利用開始/終了、数量、作成日時。

#### 4.8.2 管理者向けカレンダー高度化

- `/admin` または `/admin/reservations` に週ビューを追加し、機材・部署・ステータスでフィルタ。
- ホバーで詳細ツールチップ、クリックでモーダル。将来的にステータス変更やキャンセル操作を追加。

#### 4.8.3 データ基盤・API 安定化（検討）

- SQLite からサーバ型 RDB（PostgreSQL / MySQL）への移行、接続プール、悲観/楽観ロック整備。
- Redis 等のキャッシュ導入、バッチ集計、DWH 連携（BigQuery など）で分析基盤を強化。
- Docker 化、オートスケール、APM/ログ監視、バックアップ自動化による運用強化。

### 4.9 マスターデータ／DB 管理方針

- 資機材カテゴリ・マスタをコード化して Git 管理し、シード／マイグレーションで投入。
- `reset-equipment.ts` 等の定型コマンドで初期データを再構築し、`database.sqlite` などのバイナリは Git 管理外に置く。
- Pull Request ベースでマスタ変更をレビューし、本番 DB には自動バックアップとロールフォワード／ロールバック手順を用意。

## 5. データ要件

### 5.1 主なデータモデル

- **ユーザ**: 氏名、所属、連絡先、役職、認証情報、ロール。
- **資機材**: ID、カテゴリ、名称、保有数、保管場所、利用条件、備考。
- **予約**: 予約ID、ユーザID、資機材ID、利用期間、数量（デフォルト1）、用途、ステータス、承認者、作成日時、更新日時。
- **カレンダーイベント**: 資機材ID、期間、予約/メンテナンス種別。
- **通知履歴**: 種別、送信先、送信日時、結果。
- **ログ**: 操作種別、対象ID、実行者、日時、詳細。

#### 5.1.1 資機材カテゴリ分類

- 資機材は、以下のカテゴリに分類して管理する。
  - **蘇生講習資機材**
  - **トレーニング資機材**
  - **機械類**
  - **消耗品**
  - **その他**
- 画面上のカテゴリ選択肢や一覧表示では、上記の順序（蘇生講習資機材 → トレーニング資機材 → 機械類 → 消耗品 → その他）で表示することを基本とする。
- 各カテゴリ配下には、院内で使用している具体的な物品（例: ALS Simulator, Resusci Anne, AEDトレーナー 等）を資機材マスタとして登録する。
- 物品名が複数の呼称を持つ場合は、1つの資機材レコードに対して別名（エイリアス）として扱う。
  - 例: **「超音波トレーニングシミュレーター」** と **「経食道心エコー基本システム」** は同一物品として1レコードで管理し、画面上ではいずれの名称でも検索・識別できるようにする（カテゴリは「トレーニング資機材」とする）。

### 5.2 データ制約

- 1予約で保有数を超える数量指定を不可とする。
- 重複予約判定は「資機材ID × 時間帯 × 数量条件」で行う。
- 過去データ保存期間（例：5年）を定義しアーカイブ方式を決定する。

## 6. 非機能要件

### 6.1 ユーザビリティ

- PCブラウザ（Edge/Chrome）最適化、レスポンシブ対応（タブレット）。
- カレンダー操作性（ドラッグ＆ドロップ、ツールチップ表示）。
- アクセシビリティ（キーボード操作、色弱対応）。

### 6.2 パフォーマンス

- 同時アクセス数50ユーザでも2秒以内のレスポンスを目標とする。
- 予約登録時の競合処理（悲観／楽観ロックまたはトランザクション管理）。

### 6.3 セキュリティ

- HTTPS通信必須。
- パスワードポリシー／アカウントロック。
- 権限による閲覧制限（他部署予約の詳細閲覧権限制御）。
- ログの改ざん防止と定期バックアップ。

### 6.4 可用性・保守性

- 稼働時間: 平日24時間を想定（メンテナンス時間帯設定）。
- 障害通知と復旧手順の整備。
- バージョン管理・テスト環境での検証フロー。

### 6.5 法令・コンプライアンス

- 個人情報保護（利用者情報は最小限で暗号化保管）。
- 監査要件に沿ったアクセスログ保持。

## 7. インテグレーション要件

- 既存人事システム／LDAPとのユーザ連携（任意）。
- Outlook/Googleカレンダー連携（ICS配信）を検討。
- 既存申請書PDFの出力（電子申請書としてアーカイブ）。

## 8. システム構成要件（案）

- Webアプリ構成（フロント：SPAまたはサーバサイドレンダリング、バックエンド：Firebase を用いた REST API / サーバーレス構成）。
- 認証・認可: Firebase Authentication を利用し、ユーザのログイン・ロール管理と連携。
- データベース：Firebase Firestore などのマネージド NoSQL データベースを基本とし、必要に応じて別途リレーショナルDB（例：PostgreSQL/MySQL）を検討。
- 業務ロジック: Firebase Cloud Functions 等を利用したサーバーレス処理（予約競合チェック、通知処理、バッチ処理など）。
- ガントチャート表示ライブラリ（例：DHTMLX Gantt、FullCalendar＋カスタム）。

## 9. 移行・運用計画

- 既存Excel/紙申請からの初期データ登録手順を整備。
- 利用者向けトレーニング資料、FAQを用意。
- 運用フロー（承認ルール、返却確認、機材メンテ処理）を確立。

---

### 次のステップ（推奨）

1. 関係部署とのレビューで要件確定。
2. 画面プロトタイプ作成とフィードバック収集。
3. システムアーキテクチャ案・スケジュール策定。
