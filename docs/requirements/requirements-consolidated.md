# サザンウィズ資機材予約システム 統合要件定義

> **最終更新**: 2026-02-02  
> **ステータス**: 実装中（一部機能は計画中）

---

## 1. プロジェクト概要

### 1.1 目的
救急・トレーニング機材や消耗品の貸出申請をWeb化し、利用者の予約と管理者のモニタリングを一元化する。

### 1.2 対象範囲
- 蘇生講習資機材
- トレーニング資機材
- 機械類
- 消耗品
- その他

### 1.3 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | React + Vite + Chakra UI |
| バックエンド | Firebase (Firestore, Authentication) |
| 画像ストレージ | Google Drive共有リンク方式 |
| 開発サーバー | `npm run dev` → http://localhost:5174 |

---

## 2. ステークホルダーとロール

| ロール | 権限・責務 |
|--------|-----------|
| **一般ユーザ** | 資機材検索、予約・キャンセル |
| **管理者** | 資機材マスタ管理、予約承認／却下、通知設定 |
| **システム管理者** | ユーザ・ロール管理、監査ログ、バックアップ |

---

## 3. 利用シナリオ

1. 利用者がSSO または ID/パスワードでログイン
2. カテゴリ・検索条件で資機材を絞り込み、詳細情報を確認
3. カレンダーから利用期間を選択し、利用目的・場所・連絡先を入力して予約申請
4. システムが保有数・重複をチェックし、条件未達時は理由付きで差し戻し
5. 管理者がダッシュボードで予約を確認し、承認・調整を実施
6. 返却期限前に通知、利用完了後は実績として記録

---

## 4. 機能要件

### 4.1 認証・認可 ✅ 実装済

| 項目 | 仕様 |
|------|------|
| 認証方式 | SSO または ID/パスワード |
| ロール | `user` / `admin` / `system_admin` |
| トークン | JWT発行、`/auth/me` で利用者情報取得 |
| 開発用アカウント | `admin@sazan-with.local` / `Sazan-Admin@2025` |

### 4.2 資機材管理 ✅ 実装済

| 項目 | 仕様 |
|------|------|
| マスタ項目 | 名称、カテゴリ、保有数、保管場所、備考、利用制限 |
| カテゴリ順序 | 蘇生講習資機材 → トレーニング資機材 → 機械類 → 消耗品 → その他 |
| 画像保存 | Google Drive共有リンク（詳細は[5.1](#51-画像ストレージ)参照） |
| 論理削除 | `isActive` / `isDeleted` フラグ |

### 4.3 予約機能（利用者向け） ✅ 実装済

- カテゴリ／フリーワード／部署フィルタで検索
- カレンダー表示（月/週/日ビュー）で予約可否確認
- 「予約可能」「残り○」「×」などの状態表示
- モーダルで開始・終了日時、利用目的、場所、連絡先を入力
- 保有数チェックと重複判定
- 予約履歴参照、ステータス確認、キャンセル

### 4.4 予約管理（管理者向け） ✅ 実装済

- 予約一覧（フィルタ：日付、資機材、部署、ステータス）
- ガントチャート／FullCalendarによる視覚化
- 承認ワークフロー（自動/手動）
- 強制キャンセル、コメント履歴

### 4.5 管理画面（システム管理者向け） ✅ 実装済

- ユーザ／ロール管理
- メンテナンスモード設定
- 管理者アカウントの論理削除（確認ダイアログ付き）
- `system_admin` のみが `system_admin` を削除可能

### 4.6 通知 ⏳ 未実装

| トリガー | 内容 |
|---------|------|
| 予約受付 | 申請者へ確認メール |
| 承認時 | 申請者へ通知 |
| 却下時 | 申請者へ通知（理由付き） |
| キャンセル時 | 関係者へ通知 |
| 返却期限前 | リマインダ（前日・当日） |

- メールテンプレート編集機能
- SMTP / SendGrid / AWS SES 等で送信

### 4.7 監査・ログ ⏳ 未実装

| 記録対象 | 項目 |
|---------|------|
| ログイン履歴 | 成功・失敗 |
| 予約操作 | 作成・更新・キャンセル・承認・却下 |
| 管理アクション | ユーザー作成・削除、機材登録・更新 |

- 記録項目: 操作種別、対象ID、実行者ID、日時、詳細、IPアドレス
- ログ改ざん防止（署名または外部保管）

---

## 5. 画像ストレージ仕様 ✅ 実装済

### 5.1 方式

**Google Drive直接URL方式** を採用（Firebase Storage不使用でコスト削減）

| 項目 | 仕様 |
|------|------|
| 保存場所 | 管理者のGoogle Driveアカウント |
| URL形式 | Google Drive共有リンク |
| 表示形式 | thumbnail API経由でサムネイル取得 |
| 編集権限 | 管理者ページからのみ |

### 5.2 URL変換ロジック

| 入力形式 | 変換後 |
|---------|--------|
| `https://drive.google.com/file/d/{FILE_ID}/view...` | `https://drive.google.com/thumbnail?id={FILE_ID}&sz=w400` |
| `{FILE_ID}`（20文字以上の英数字） | `https://drive.google.com/thumbnail?id={FILE_ID}&sz=w400` |
| その他のURL | そのまま表示 |

### 5.3 運用手順

1. Google Driveに画像をアップロード
2. ファイルを右クリック → 「共有」
3. 「一般的なアクセス」を「リンクを知っている全員」に変更
4. 「リンクをコピー」をクリック
5. 管理者ページ → 資機材編集 → 「画像URL」に貼り付け
6. 保存

### 5.4 リスクと対策

| リスク | 対策 |
|--------|------|
| 共有設定忘れ | シークレットウィンドウで事前確認 |
| ファイル移動・削除 | 画像専用フォルダで管理 |
| Google API変更 | 代替方式の検討（uc?export形式等） |
| Drive容量超過 | 容量監視、不要ファイル削除 |

---

## 6. データ要件

### 6.1 エンティティ

| エンティティ | 主なフィールド |
|-------------|---------------|
| **User** | 氏名、所属、連絡先、役職、認証情報、ロール |
| **Equipment** | ID、カテゴリ、名称、保有数、保管場所、imageUrl |
| **Reservation** | 予約ID、ユーザID、資機材ID、利用期間、数量、用途、ステータス |
| **EquipmentCategory** | カテゴリ名、説明、紐づく資機材一覧 |
| **NotificationTemplate** | （未実装）種別、件名、本文テンプレート |
| **AuditLog** | （未実装）操作種別、対象ID、実行者、日時、詳細 |

### 6.2 制約

- 1予約で保有数を超える数量指定は不可
- 重複予約判定: 資機材ID × 時間帯 × 数量条件
- 過去データ保存期間: 5年（アーカイブ方式要検討）

---

## 7. 非機能要件

| 項目 | 要件 |
|------|------|
| **ユーザビリティ** | PCブラウザ（Edge/Chrome）最適化、レスポンシブ対応 |
| **パフォーマンス** | 同時50ユーザで2秒以内のレスポンス |
| **セキュリティ** | HTTPS必須、パスワードポリシー、権限制御 |
| **可用性** | 平日24時間稼働想定 |
| **コンプライアンス** | 個人情報保護、監査ログ保持 |

---

## 8. Googleシステム連携 ⏳ 検討中

### 8.1 連携対象

- ユーザー情報（`users`）
- 資機材情報（`equipments`）
- 予約情報（`reservations`）
- カテゴリ情報（`equipment_categories`）

### 8.2 連携先候補

| 方式 | 用途 |
|------|------|
| **BigQuery（推奨）** | 大量データ蓄積＋分析 |
| **Cloud SQL** | 既存RDB互換が必要な場合 |
| **Google Sheets** | 軽量な共有・参照用途 |

### 8.3 同期方式

- `createdAt` / `updatedAt` を用いた増分同期
- Cloud Scheduler → Cloud Run Job または GitHub Actions で定期実行

---

## 9. 次期開発項目

### 9.1 中優先度

| 項目 | 工数目安 | 詳細 |
|------|---------|------|
| CSVエクスポートAPI | 0.5日 | `GET /api/reservations/export`、管理者限定 |
| ユーザー向け予約履歴画面 | 1日 | `/my-reservations`、キャンセル機能付き |
| ダッシュボード「今月の予約」 | 0.5日 | 月次統計表示 |

### 9.2 低優先度

| 項目 | 工数目安 | 詳細 |
|------|---------|------|
| 通知機能 | 2-3日 | メール送信、テンプレート管理 |
| 監査ログ | 1-2日 | 操作履歴記録、検索機能 |
| パスワードポリシー | 1日 | 複雑性要件、アカウントロック |
| Equipment別名フィールド | 0.5日 | 複数呼称での検索対応 |

---

## 10. マスターデータ管理

- 資機材カテゴリ・マスタをコード化してGit管理
- `reset-equipment.ts` 等の定型コマンドで初期データを再構築
- `database.sqlite` などのバイナリはGit管理外
- Pull Requestベースでマスタ変更をレビュー

---

## 11. 移行・運用計画

- 既存Excel/紙申請からの初期データ登録手順を整備
- 利用者向けトレーニング資料、FAQを用意
- 運用フロー（承認ルール、返却確認、機材メンテ処理）を確立

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-02 | 要件定義1〜4を統合して本ドキュメントを作成 |
| 2026-01-27 | 要件定義4（画像ストレージ仕様）追加、requirements-1.md を現行仕様に更新 |
| 2025-12-09 | 要件定義3（次期開発項目）追加、ドキュメント整理 |
