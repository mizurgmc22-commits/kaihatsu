# 要件定義4: 画像ストレージ仕様（現行）

## 概要

本ドキュメントは、資機材画像の保存・表示に関する現行仕様を定義するものです。

---

## 1. 背景と方針

### 1.1 Firebase Storage 非採用の理由

- **コスト**: Firebase Storage は従量課金制（保存・ダウンロード・アップロード）
- **無料枠超過リスク**: 画像アクセス頻度によっては課金発生
- **代替策**: Google Drive の無料ストレージ（15GB）を活用

### 1.2 採用方式

**Google Drive 直接URL方式** を採用

| 項目         | 仕様                              |
| ------------ | --------------------------------- |
| 画像保存場所 | 管理者のGoogle Driveアカウント    |
| URL形式      | Google Drive共有リンク            |
| 表示形式     | thumbnail API経由でサムネイル取得 |
| 編集権限     | 管理者ページからのみ              |

---

## 2. 技術仕様

### 2.1 データ構造

```typescript
// Equipment エンティティ
interface Equipment {
  // ... 他のフィールド
  imageUrl?: string; // Google Drive共有URL（元のURLをそのまま保存）
}
```

### 2.2 URL変換ロジック

**保存時**: 入力されたURLをそのまま Firestore に保存

**表示時**: `resolveEquipmentImage()` 関数で表示用URLに変換

| 入力形式                                            | 変換後                                                    |
| --------------------------------------------------- | --------------------------------------------------------- |
| `https://drive.google.com/file/d/{FILE_ID}/view...` | `https://drive.google.com/thumbnail?id={FILE_ID}&sz=w400` |
| `{FILE_ID}` （20文字以上の英数字）                  | `https://drive.google.com/thumbnail?id={FILE_ID}&sz=w400` |
| その他のURL                                         | そのまま表示                                              |

### 2.3 関連ファイル

| ファイル                                              | 役割                          |
| ----------------------------------------------------- | ----------------------------- |
| `frontend/src/api/equipment.ts`                       | 資機材CRUD、URL保存処理       |
| `frontend/src/constants/equipmentImageOverrides.ts`   | 表示時のURL変換               |
| `frontend/src/pages/equipment/EquipmentFormModal.tsx` | 管理者向け画像URL入力フォーム |

---

## 3. 運用手順

### 3.1 画像登録手順（管理者）

1. Google Driveに画像をアップロード
2. ファイルを右クリック → 「共有」
3. 「一般的なアクセス」を「リンクを知っている全員」に変更
4. 「リンクをコピー」をクリック
5. 管理者ページ → 資機材編集 → 「画像URL（Google Drive）」に貼り付け
6. 保存

### 3.2 確認方法

- シークレットウィンドウで共有リンクを開き、画像が表示されることを確認
- ユーザー向け資機材一覧でサムネイルが表示されることを確認

---

## 4. セキュリティ

### 4.1 保護されている項目

| 項目                   | 保護状態                        |
| ---------------------- | ------------------------------- |
| Google Drive元ファイル | ✅ 閲覧者は編集・削除不可       |
| Firestore データ       | ✅ 認証済みユーザーのみアクセス |
| 画像URL編集            | ✅ 管理者ログイン必須           |

### 4.2 制限事項

| 項目                 | 制限                         |
| -------------------- | ---------------------------- |
| サムネイル画像の保存 | ❌ 防止不可（Webの仕組み上） |
| スクリーンショット   | ❌ 技術的に防止不可          |

### 4.3 組織アカウント利用時の注意

- Google Workspace（大学・病院等）のアカウントでは外部共有が制限されている場合がある
- 制限がある場合は個人Googleアカウントでの画像管理を推奨

---

## 5. 制限事項とリスク

| リスク             | 影響                        | 対策                               |
| ------------------ | --------------------------- | ---------------------------------- |
| 共有設定忘れ       | 画像が表示されない          | シークレットウィンドウでの事前確認 |
| ファイル移動・削除 | URLが無効化                 | 画像専用フォルダでの管理推奨       |
| Google API変更     | thumbnail URL無効化の可能性 | 代替方式の検討（uc?export形式等）  |
| Drive容量超過      | 新規画像追加不可            | 容量監視、不要ファイル削除         |

---

## 6. 関連ドキュメント

- [要件定義1（メイン）](./requirements-1.md) - システム全体の要件定義
- [要件定義2](./requirements-2.md) - Google システムへのデータ連携
- [要件定義3](./requirements-3.md) - 次期開発項目

---

## 変更履歴

| 日付       | 内容                                                    |
| ---------- | ------------------------------------------------------- |
| 2026-01-27 | 初版作成（Firebase Storage → Google Drive方式への移行） |
