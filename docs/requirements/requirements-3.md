# 要件定義3: 次期開発項目

## 概要
本ドキュメントは、現行システムのレビューに基づき、今後実装すべき機能改善・拡張項目をまとめたものです。

---

## 1. 中優先度（機能改善）

### 1.1 CSV エクスポート API の実装

**目的**: 管理者が予約データを CSV 形式でダウンロードし、外部ツールでの分析や報告書作成に活用できるようにする。

**要件**:
- エンドポイント: `GET /api/reservations/export`
- 管理者権限（`admin` / `system_admin`）のみアクセス可能
- クエリパラメータでフィルタ条件を指定可能（ステータス、日付範囲、機材ID、部署など）
- ページネーションを無視し、条件に一致する全件を出力
- レスポンス形式: `text/csv`
- 出力列:
  - 予約ID
  - ステータス
  - 機材名
  - 部署
  - 申請者名
  - 連絡先
  - 利用開始日時
  - 利用終了日時
  - 数量
  - 利用目的
  - 利用場所
  - 作成日時

**実装箇所**:
- バックエンド: `backend/src/routes/reservation.ts` に新規エンドポイント追加
- フロントエンド: `frontend/src/pages/admin/ReservationManagement.tsx` の「CSVダウンロード」ボタンと接続

---

### 1.2 ユーザー向け予約履歴・キャンセル画面の追加

**目的**: 一般ユーザーが自分の予約履歴を確認し、必要に応じてキャンセルできるようにする。

**要件**:
- 新規ページ: `/my-reservations` または `/reservations/history`
- 認証必須（ログインユーザーのみアクセス可能）
- 表示項目:
  - 予約一覧（自分が申請した予約のみ）
  - ステータス表示（承認待ち、承認済み、却下、キャンセル、完了）
  - 予約詳細の確認
- 機能:
  - 予約のキャンセル（承認待ち・承認済みの予約のみ、開始日前まで）
  - キャンセル時の確認ダイアログ表示

**実装箇所**:
- フロントエンド: `frontend/src/pages/reservations/MyReservations.tsx` 新規作成
- バックエンド: 既存の `GET /api/reservations` に `userId` フィルタを追加
- ルーティング: `App.tsx` に新規ルート追加

---

### 1.3 ダッシュボード「今月の予約」の実装

**目的**: 管理者ダッシュボードで今月の予約件数を表示し、月次の利用状況を把握できるようにする。

**要件**:
- 現在の月の予約総数を表示
- バックエンド API で集計（`GET /api/dashboard/stats` の拡張）
- 前月比の増減表示（オプション）

**実装箇所**:
- バックエンド: `backend/src/routes/dashboard.ts` に今月の予約数集計を追加
- フロントエンド: `frontend/src/pages/admin/AdminDashboard.tsx` の該当カードを更新

---

## 2. 低優先度（将来対応）

### 2.1 通知機能の実装

**目的**: 予約の状態変化や期限に関する通知をユーザー・管理者に送信する。

**要件**:
- 通知トリガー:
  - 予約受付時（申請者へ確認メール）
  - 承認時（申請者へ通知）
  - 却下時（申請者へ通知、理由付き）
  - キャンセル時（関係者へ通知）
  - 返却期限前リマインダ（前日・当日）
  - 上限超過・メンテナンス開始アラート
- 通知手段: メール（SMTP / SendGrid / AWS SES など）
- 管理画面からメールテンプレートを編集可能

**実装箇所**:
- 新規エンティティ: `NotificationTemplate`, `NotificationLog`
- バックエンド: `backend/src/services/notification.ts` 新規作成
- 管理画面: 通知テンプレート編集ページ

---

### 2.2 監査ログの実装

**目的**: システム操作の履歴を記録し、セキュリティ監査や問題調査に活用する。

**要件**:
- 記録対象:
  - ログイン履歴（成功・失敗）
  - 予約操作（作成・更新・キャンセル・承認・却下）
  - 管理アクション（ユーザー作成・削除、機材登録・更新など）
- 記録項目:
  - 操作種別
  - 対象ID
  - 実行者ID
  - 実行日時
  - 詳細（変更前後の値など）
  - IPアドレス
- 検索・エクスポート機能
- ログ改ざん防止（署名または外部保管）

**実装箇所**:
- 新規エンティティ: `AuditLog`
- バックエンド: ミドルウェアまたはサービスで自動記録
- 管理画面: 監査ログ閲覧ページ

---

### 2.3 パスワードポリシーの実装

**目的**: セキュリティ強化のため、パスワードの複雑性要件とアカウントロック機能を実装する。

**要件**:
- パスワードポリシー:
  - 最小文字数: 8文字以上
  - 複雑性: 英大文字・英小文字・数字・記号のうち3種類以上
  - 過去パスワードの再利用禁止（直近5回分）
  - 有効期限: 90日（オプション）
- アカウントロック:
  - 連続ログイン失敗: 5回でロック
  - ロック解除: 30分後に自動解除、または管理者による手動解除
- 初回ログイン時のパスワード変更強制

**実装箇所**:
- バックエンド: `backend/src/routes/auth.ts` にバリデーション追加
- 新規カラム: `User` エンティティに `failedLoginAttempts`, `lockedUntil`, `passwordChangedAt` 追加

---

### 2.4 Equipment に別名（エイリアス）フィールド追加

**目的**: 同一機材が複数の呼称を持つ場合に、いずれの名称でも検索・識別できるようにする。

**要件**:
- `Equipment` エンティティに `aliases` フィールドを追加（JSON配列または別テーブル）
- 検索時に別名も対象に含める
- 画面上では主名称を表示し、別名はツールチップや詳細画面で確認可能

**例**:
- 主名称: 「超音波トレーニングシミュレーター」
- 別名: 「経食道心エコー基本システム」

**実装箇所**:
- バックエンド: `Equipment` エンティティに `aliases: string[]` 追加
- 検索ロジック: `GET /api/equipment` の検索条件を拡張

---

## 3. 実装優先順位

| 優先度 | 項目 | 工数目安 |
|--------|------|----------|
| 中 | CSV エクスポート API | 0.5日 |
| 中 | ユーザー向け予約履歴・キャンセル画面 | 1日 |
| 中 | ダッシュボード「今月の予約」 | 0.5日 |
| 低 | 通知機能 | 2-3日 |
| 低 | 監査ログ | 1-2日 |
| 低 | パスワードポリシー | 1日 |
| 低 | Equipment 別名フィールド | 0.5日 |

---

## 4. 関連ドキュメント

- [要件定義1（メイン）](./requirements-1.md) - システム全体の要件定義
- [要件定義2](./requirements-2.md) - Google システムへのデータ連携
